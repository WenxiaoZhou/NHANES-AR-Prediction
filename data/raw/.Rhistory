vjust = -1.2, color = "#e41a1c", size = 4.5, fontface = "bold"
) +
geom_point(data = min_point, aes(x = x_value, y = cum_shap),
color = "#377eb8", size = 3) +
geom_text(
data = min_point,
aes(x = x_value, y = cum_shap,
label = sprintf("x=%.4f\ncum=%.4f", x_value, cum_shap)),
vjust = 2.0, color = "#377eb8", size = 4.5, fontface = "bold"
) +
labs(
title = paste0("Force-like cumulative SHAP for ", display_name),
subtitle = "Red = positive cumulative SHAP; Blue = negative cumulative SHAP",
x = x_var,
y = paste0("Cumulative SHAP (", input$feature_display, ")")
) +
coord_cartesian(ylim = c(y_min - y_pad, y_max + y_pad)) +
theme_minimal(base_size = 16)
ggplotly(p, tooltip = c("x", "y")) %>%
layout(hoverlabel = list(font = list(size = 13)))
})
# =====================================================
# (2) Aggregated Trend Plot — segmented with extrema annotations
# =====================================================
output$aggPlot <- renderPlotly({
df_plot <- df_filtered()
req(input$x_var)
x_var <- input$x_var
df_plot$x_value <- test_baked_clean[[x_var]]
display_name <- group_display_map$display[group_display_map$group == input$feature_display]
if (length(display_name) == 0) display_name <- input$feature_display
x_is_continuous <- is.numeric(df_plot$x_value) && length(unique(df_plot$x_value)) > 5
if (!x_is_continuous) return(NULL)
df_agg <- df_plot %>%
group_by(x_value) %>%
summarise(mean_y = mean(y_value, na.rm = TRUE), .groups = "drop") %>%
arrange(x_value) %>%
mutate(cum_shap = cumsum(mean_y))
max_point <- df_agg %>% slice(which.max(cum_shap))
min_point <- df_agg %>% slice(which.min(cum_shap))
y_min <- min(df_agg$cum_shap, na.rm = TRUE)
y_max <- max(df_agg$cum_shap, na.rm = TRUE)
y_pad <- 0.25 * (y_max - y_min)
p <- geom_force_ribbon(df_agg) +
geom_line(data = df_agg, aes(x = x_value, y = cum_shap),
color = "gray40", linewidth = 0.4) +
geom_hline(yintercept = 0, linetype = "dashed", color = "gray60") +
geom_point(data = max_point, aes(x = x_value, y = cum_shap),
color = "#e41a1c", size = 3) +
geom_text(
data = max_point,
aes(x = x_value, y = cum_shap,
label = sprintf("x=%.4f\nmean=%.4f", x_value, cum_shap)),
vjust = -1.2, color = "#e41a1c", size = 4.5, fontface = "bold"
) +
geom_point(data = min_point, aes(x = x_value, y = cum_shap),
color = "#377eb8", size = 3) +
geom_text(
data = min_point,
aes(x = x_value, y = cum_shap,
label = sprintf("x=%.4f\nmean=%.4f", x_value, cum_shap)),
vjust = 2.0, color = "#377eb8", size = 4.5, fontface = "bold"
) +
labs(
title = paste0("Aggregated cumulative SHAP trend for ", display_name),
subtitle = "Mean SHAP per X, segmented cumulative trend",
x = x_var,
y = paste0("Aggregated mean SHAP (", input$feature_display, ")")
) +
coord_cartesian(ylim = c(y_min - y_pad, y_max + y_pad)) +
theme_minimal(base_size = 16)
ggplotly(p, tooltip = c("x", "y")) %>%
layout(hoverlabel = list(font = list(size = 13)))
})
# =====================================================
# (3) Summary Importance Plot
# =====================================================
output$summaryPlot <- renderPlotly({
mean_abs_shap <- round(colMeans(abs(shap_values_shap_avg)), 4)
df_sum <- tibble(feature = names(mean_abs_shap),
importance = mean_abs_shap) %>%
arrange(desc(importance)) %>%
slice(1:25)
p <- ggplot(df_sum, aes(x = reorder(feature, importance), y = importance)) +
geom_col(fill = "#3182bd") +
geom_text(aes(label = sprintf("%.4f", importance)),
hjust = -0.1, size = 4.2, fontface = "bold", color = "gray15") +
coord_flip() +
labs(title = "Top 25 most important features (mean |SHAP|)",
x = NULL, y = "Mean |SHAP| value") +
theme_minimal(base_size = 16)
ggplotly(p)
})
}
# =========================================================
# Run App
# =========================================================
shinyApp(ui, server)
setwd('/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/data/raw')
library(haven)
library(dplyr)
library(purrr)
######################## Read raw datasets ########################
# Health Insurance
HIQ_D<-read_xpt("HIQ_D.xpt")
#Smoking
SMQ_D<-read_xpt("SMQ_D.xpt")
#Housing Characteristics
HOQ_D<-read_xpt("HOQ_D.xpt")
#Continine Serum
COT_D<-read_xpt("COT_D.xpt")
#C-Reactive Protein
CRP_D<-read_xpt("CRP_D.xpt")
#Allergen Specific IgE
AL_IGE_D<-read_xpt("AL_IGE_D.xpt")
#Body Measures
BMX_D<-read_xpt("BMX_D.xpt")
#Demographic
DEMO_D<-read_xpt("DEMO_D.xpt")
#Complete Blood Count
CBC_D<-read_xpt("CBC_D.xpt")
#Allergy
AGQ_D<-read_xpt("AGQ_D.xpt")
#Medical Conditions
MCQ_D<-read_xpt("MCQ_D.xpt")
#Hospital Utilization and Access to Care
HUQ_D<-read_xpt("HUQ_D.xpt")
#Prescription Medications
#RXQ_RX_D<-read_xpt("RXQ_RX_D.xpt")
#Drug Information
#RXQ_DRUG<-read_xpt("RXQ_DRUG.xpt")
######################## Data Pre-processor ########################
ageband<- function(age,
breaks = c(0, 6, 12, 20, 40, 60, 85, Inf),
labels = c("0-5","6-11","12-19","20-39","40-59","60-84","85+")) {
cut(age, breaks = breaks, labels = labels,
right = FALSE, include.lowest = TRUE)
}
yn_factor <- function(x) recode_factor(as.integer(x),
`1`="Yes",
`2`="No",
`7`=NA_character_,
`9`=NA_character_,
.default=NA_character_)
yn01 <- function(x) {
x <- na_sentinels(x)
dplyr::case_when(
x %in% c(1L, "1") ~ 1L,
x %in% c(2L, "2") ~ 0L,
TRUE ~ NA_integer_
)
}
DEMO_D1<-DEMO_D %>%
select(SEQN, RIDAGEYR, RIAGENDR, RIDRETH1, DMDHHSIZ, INDHHINC, INDFMPIR, DMDEDUC2) %>%
mutate(sex=recode_factor(RIAGENDR,`1` = "Male",`2` = "Female",.default = NA_character_),
race=recode_factor(RIDRETH1, `1` = "Mexican American",`2` = "Other Hispanic",
`3` = "Non-Hispanic White",`4` = "Non-Hispanic Black",`5` = "Other/Multi",
.default = NA_character_),
home_size=DMDHHSIZ,
pir=INDFMPIR,
edu_a=case_when(RIDAGEYR<20 ~ NA_integer_,
DMDEDUC2 %in% c(7,9) ~ NA_integer_,
TRUE ~DMDEDUC2),
house_income=case_when(INDHHINC %in% c(77,99) ~ NA_integer_,
TRUE ~ INDHHINC),
age=RIDAGEYR) %>%
mutate(house_income=recode_factor(
house_income,
`1`  = "<$5,000",
`2`  = "$5,000-$9,999",
`3`  = "$10,000-$14,999",
`4`  = "$15,000-$19,999",
`5`  = "$20,000-$24,999",
`6`  = "$25,000-$34,999",
`7`  = "$35,000-$44,999",
`8`  = "$45,000-$54,999",
`9`  = "$55,000-$64,999",
`10` = "$65,000-$74,999",
`11` = ">=$75,000",
`12` = "Over $20,000",
`13` = "Under $20,000"),
edu_a=recode_factor(
as.character(edu_a),
`1` = "< 9th grade",
`2` = "9-11th (incl 12th no diploma)",
`3` = "High school/GED",
`4` = "Some college/AA",
`5` = "College graduate or above",
.default = NA_character_),
age_grp=ageband(age)) %>%
select(SEQN, age, age_grp, sex, race, home_size, pir, edu_a, house_income)
BMX_D1<-BMX_D %>% select(SEQN, BMXBMI)
BMX_D2<-DEMO_D1 %>%
select(SEQN, age) %>%
left_join(BMX_D1,by='SEQN') %>%
mutate(bmi_cat=ifelse(
is.na(BMXBMI), NA_character_,
as.character(cut(
BMXBMI,
breaks=c(-Inf, 18.5,25,30,35,40,Inf),
labels=c("Underweight","Normal","Overweight",
"Obesity I","Obesity II","Obesity III"),
right = FALSE)))) %>%
mutate(bmi_cat=factor(
bmi_cat,
levels=c("Underweight","Normal","Overweight",
"Obesity I","Obesity II","Obesity III"),
ordered = TRUE)) %>%
select(SEQN, BMXBMI,bmi_cat)
MCQ_D1<-MCQ_D %>%
select(SEQN, MCQ010, MCQ300B) %>%
mutate(asthma_ever=yn_factor(MCQ010),
fam_asthma_ever=yn_factor(MCQ300B)) %>%
select(SEQN, asthma_ever,fam_asthma_ever)
COT_D1<-COT_D %>%
select(SEQN, LBXCOT) %>%
mutate(cot_ng_ml=as.numeric(LBXCOT)) %>%
select(SEQN, cot_ng_ml)
CRP_D1<-CRP_D %>%
select(SEQN, LBXCRP) %>%
mutate(crp_mg_l=LBXCRP*10,
crp_grp=case_when(
#Leave a mark of >10 mg/L to exclude acute inflammation in the main analysis
is.na(crp_mg_l) ~ NA_integer_,
crp_mg_l>10 ~ 1L,
TRUE        ~ 0L)
) %>%
select(SEQN, crp_mg_l, crp_grp)
SMQ_D1<-SMQ_D %>%
select(SEQN, SMQ020, SMQ040) %>%
mutate(smq_ever=recode_factor(SMQ020,
`1` = "Yes",
`2` = "No",
.default = NA_character_),
smq_now=recode_factor(SMQ040,
`1`="Every day", `2`="Some days", `3`="Not at all",
`7`=NA_character_, `9`=NA_character_, .default = NA_character_),
smq_status=case_when(
smq_ever=='No' ~ "Never",
smq_ever=='Yes' & smq_now %in% c("Every day","Some days") ~ "Current",
smq_ever=='Yes' & smq_now == "Not at all" ~ "Former",
TRUE ~ NA_character_
),
smq_status=factor(smq_status,levels=c("Never","Former","Current"))
) %>%
select(SEQN, smq_status)
HIQ_D1<-HIQ_D %>%
select(SEQN, HIQ011, HIQ260, HIQ270, HIQ210) %>%
mutate(insurance=recode_factor(HIQ011,
`1` = "Yes",
`2` = "No",
.default = NA_character_),
medicare=recode_factor(HIQ260,
`1` = "Yes",
`2` = "No",
.default = NA_character_),
any_ins=case_when(insurance=='Yes' | medicare=='Yes' ~ "Yes",
insurance=='No' & medicare=='No' ~ "No",
TRUE ~ NA_character_),
ins_prescip=recode_factor(HIQ270,`1` = "Yes",
`2` = "No",
.default = NA_character_),
no_insure=recode_factor(HIQ210,
`1` = "Yes",
`2` = "No",
.default = NA_character_)) %>%
select(SEQN, any_ins, ins_prescip, no_insure)
HUQ_D1<-HUQ_D %>%
select(SEQN, HUQ010, HUQ030, HUQ050, HUQ060) %>%
mutate(health=recode_factor(HUQ010,
`1`="Excellent", `2`="Very Good", `3`="Good",
`4`="Fair", `5`="Poor",`7`=NA_character_,
`9`=NA_character_, .default = NA_character_),
routine_visit=case_when(
HUQ030==1|HUQ030==3 ~ "Yes",
HUQ030==2 ~ "No",
TRUE ~ NA_character_),
time_visit=recode_factor(
as.character(HUQ050),
"0"  = "None",
"1"  = "1",
"2"  = "2–3",
"3"  = "4–9",
"4"  = "10–12",
"5"  = "13+",
"77" = NA_character_,
"99" = NA_character_,
.default = NA_character_,
.ordered = TRUE),
time_last=recode_factor(
as.character(HUQ060),
"1"  = "<=6 months",
"2"  = "6–12 months",
"3"  = "1–3 years",
"4"  = ">3 years",
"5"  = "Never",
"7"  = NA_character_,
"9"  = NA_character_,
.default = NA_character_,
.ordered = TRUE
)) %>%
select(SEQN,health,routine_visit,time_visit,time_last)
CBC_D1<-CBC_D %>%
select(SEQN, LBDEONO, LBXNEPCT, LBXLYPCT, LBXBAPCT, LBXEOPCT) %>%
mutate(across(c(LBDEONO, LBXNEPCT, LBXLYPCT, LBXBAPCT, LBXEOPCT), ~ as.numeric(.x)),
across(c(LBXNEPCT, LBXLYPCT, LBXBAPCT, LBXEOPCT), ~ ifelse(.x<0|.x>100, NA_real_, .x))) %>%
#common thresholds related to AR:
#Absolute count ≥0.5*10^3/µL or percentage ≥5%
mutate(eos_high=ifelse(!is.na(LBDEONO) & LBDEONO>=0.5, 1L, 0L),
eos_high_pct=ifelse(!is.na(LBXEOPCT) & LBXEOPCT>=5, 1L, 0L),
eos_high_any=ifelse(eos_high==1L | eos_high_pct==1L, 1L, 0L)) %>%
#ratio indicators
mutate(
nlr = ifelse(LBXLYPCT %in% c(0, NA), NA_real_, LBXNEPCT/LBXLYPCT),  # Neutrophils/Lymphatics
elr = ifelse(LBXLYPCT %in% c(0, NA), NA_real_, LBXEOPCT/LBXLYPCT),  # Eosinophilic/Lymphatics
enr = ifelse(LBXNEPCT  %in% c(0, NA), NA_real_, LBXEOPCT/LBXNEPCT),  # Eosinophilic/Neutrophils
# Basophil/Lymphatics
#blr = ifelse(LBXLYPCT %in% c(0, NA), NA_real_, LBXBAPCT/LBXLYPCT),
# Stratify by Eosinophils percent (for non-linear/tree models)
eos_pct_cat = cut(LBXEOPCT,
breaks = c(-Inf, 1, 3, 5, 10, Inf),
labels = c("<=1%","1-3%","3-5%","5-10%",">10%"),
right = TRUE, ordered_result = TRUE)) %>%
select(SEQN, LBDEONO, LBXEOPCT, eos_pct_cat,
eos_high_any, nlr, elr, enr)
AL_IGE_D1<-AL_IGE_D %>%
select(SEQN, LBXIGE, LBDIGELC,
LBXID2, LBXID1, LBXIE1, LBXIE5, LBXII6, LBXIM6,
LBXF13, LBXIF1, LBXIF2, LBXIW1, LBXIG5, LBXIG2,
LBXIT7, LBXIT3, LBXF24, LBXIM3, LBXW11, LBXE72, LBXE74) %>%
# Common cutoff: IgE >= 0.35 kU/L is considered positive
mutate(across(-c(SEQN, LBXIGE, LBDIGELC),
~ ifelse(!is.na(.x) & .x >= 0.35, 1L, 0L),
.names = "{.col}_pos")) %>%
mutate(any_inhalant = as.integer(rowSums(across(c(
LBXID1_pos, LBXID2_pos, LBXIE1_pos, LBXIE5_pos, LBXE72_pos, LBXE74_pos,
LBXII6_pos, LBXIM6_pos, LBXIM3_pos, LBXIW1_pos, LBXIG5_pos, LBXIG2_pos,
LBXIT7_pos, LBXIT3_pos, LBXW11_pos)), na.rm = TRUE) > 0),
any_food     = as.integer(rowSums(across(c(
LBXF13_pos, LBXIF1_pos, LBXIF2_pos, LBXF24_pos)), na.rm = TRUE) > 0),
any_sensitized = as.integer(any_inhalant == 1L | any_food == 1L)
) %>%
mutate(
LBDIGELC = case_when(
LBDIGELC == 0 ~ "At/Above detection limit",
LBDIGELC == 1 ~ "Below LOD",
LBDIGELC == 2 ~ "Above ULOQ",
is.na(LBDIGELC) ~ "Missing"),
LBDIGELC = factor(LBDIGELC,
levels = c("At/Above detection limit",
"Below LOD",
"Above ULOQ",
"Missing"))) %>%
select(SEQN, LBXIGE, LBDIGELC, any_inhalant, any_food, any_sensitized)
HOQ_D1<-HOQ_D %>%
select(SEQN, HOQ011, HOQ230, HOD050, HOQ040, HOQ250, HOQ260A,HOQ260B,HOQ260C,
HOQ270,HOQ280A,HOQ280B,HOQ280C) %>%
mutate(across(c(HOQ230, HOQ250, HOQ270,
HOQ260A, HOQ260B, HOQ260C,
HOQ280A, HOQ280B, HOQ280C),
~ case_when(
.x %in% c(1)~ 1L,.x %in% c(2)~ 0L,
.x %in% c(7,9,77,99) | is.na(.x) ~ NA_integer_,
TRUE~ NA_integer_),.names = "{.col}_yn")) %>%
mutate(any_pet_now=case_when(
HOQ250_yn == 1L ~ 1L,
rowSums(cbind(HOQ260A_yn, HOQ260B_yn, HOQ260C_yn), na.rm = TRUE) > 0 ~ 1L,
HOQ250_yn == 0L & rowSums(cbind(HOQ260A_yn, HOQ260B_yn, HOQ260C_yn), na.rm = TRUE) == 0 ~ 0L,
TRUE ~ NA_integer_),
any_pet_12m=case_when(
HOQ270_yn == 1L ~ 1L,
rowSums(cbind(HOQ280A_yn, HOQ280B_yn, HOQ280C_yn), na.rm = TRUE) > 0 ~ 1L,
HOQ270_yn == 0L & rowSums(cbind(HOQ280A_yn, HOQ280B_yn, HOQ280C_yn), na.rm = TRUE) == 0 ~ 0L,
TRUE ~ NA_integer_),
any_pet = case_when(
any_pet_now == 1L | any_pet_12m == 1L ~ 1L,
is.na(any_pet_now) & is.na(any_pet_12m) ~ NA_integer_,
TRUE ~ 0L)) %>%
mutate(mildew=HOQ230_yn,
home_type = case_when(
HOQ011 == 1 ~ "Mobile home or trailer",HOQ011 == 2 ~ "1-family house, detached",
HOQ011 == 3 ~ "1-family house, attached", HOQ011 == 4 ~ "Apartment",
HOQ011 == 6 ~ "Dormitory",
is.na(HOQ011) | HOQ011 %in% c(77, 99) ~ NA_character_,
TRUE ~ NA_character_),
home_year = case_when(
HOQ040 == 1 ~ "1990 to present",HOQ040 == 2 ~ "1978 to 1989",
HOQ040 == 3 ~ "1960 to 1977",HOQ040 == 4 ~ "1950 to 1959",
HOQ040 == 5 ~ "1940 to 1949",HOQ040 == 6 ~ "Before 1940",
is.na(HOQ040) | HOQ040 %in% c(77, 99) ~ NA_character_,
TRUE ~ NA_character_),
num_rooms = case_when(
HOD050 >= 1 & HOD050 <= 12 ~ as.character(HOD050),
HOD050 == 13 ~ "13 or more",
is.na(HOD050) | HOD050 %in% c(777, 999) ~ NA_character_,
TRUE ~ NA_character_))  %>%
select(SEQN, any_pet_now, any_pet_12m, any_pet, mildew, home_type, home_year, num_rooms)
AGQ_D1<-AGQ_D %>%
mutate(
across(c(AGQ010, AGQ030, AGQ040, AGQ060,
AGQ070, AGQ080A, AGQ080B, AGQ080C, AGQ090,
AGQ100, AGQ110A, AGQ110B, AGQ110C, AGQ110D,
AGQ120, AGQ130, AGQ140, AGQ180),
~ case_when(.x == 1 ~ 1L,
.x == 2 ~ 0L,
.x %in% c(7,9,77,99,777,999) | is.na(.x) ~ NA_integer_,
TRUE ~ NA_integer_),
.names = "{.col}_yn"),
across(c(AGD020,AGD050,AGD170),
~ case_when(.x %in% c(7,9,77,99,777,999) | is.na(.x) ~ NA_integer_,
TRUE ~ NA_integer_),
.names = "{.col}_yn")) %>%
mutate(
allergy_any=case_when(
AGQ040_yn==1L | AGQ060_yn==1L ~ 1L,
AGQ040_yn==0L & AGQ060_yn %in% c(0L,NA) ~ 0L,
AGQ060_yn==0L & AGQ040_yn %in% c(0L,NA) ~ 0L,
is.na(AGQ040_yn) & is.na(AGQ060_yn) & !is.na(AGD050) ~ 1L,
TRUE ~ NA_integer_),
animal_allergy= case_when(
rowSums(cbind(AGQ070_yn, AGQ080A_yn, AGQ080B_yn, AGQ080C_yn, AGQ090_yn), na.rm = TRUE) > 0 ~ 1L,
rowSums(is.na(cbind(AGQ070_yn, AGQ080A_yn, AGQ080B_yn, AGQ080C_yn, AGQ090_yn))) == 5 ~ NA_integer_,
TRUE ~ 0L),
sneeze_any=AGQ100_yn,
sneeze_season = {
m <- cbind(AGQ110A_yn, AGQ110B_yn, AGQ110C_yn, AGQ110D_yn)
s <- rowSums(m, na.rm = TRUE)
s[rowSums(is.na(m)) == 4] <- NA_integer_  # if all four missing, set NA
s},
sneeze_pattern = case_when(
sneeze_any == 0L ~ "none",
sneeze_any == 1L & !is.na(sneeze_season) & sneeze_season >= 3L ~ "perennial",
sneeze_any == 1L & !is.na(sneeze_season) & sneeze_season >= 1L ~ "seasonal",
sneeze_any == 1L & (is.na(sneeze_season) | sneeze_season == 0L) ~ "unknown",
TRUE ~ NA_character_),
ar_related_sx = case_when(
rowSums(cbind(AGQ120_yn, AGQ130_yn, AGQ140_yn, AGQ180_yn), na.rm = TRUE) > 0 ~ 1L,
AGQ120_yn == 0L & AGQ130_yn == 0L & AGQ140_yn == 0L & AGQ180_yn == 0L ~ 0L,
is.na(AGQ120_yn) & is.na(AGQ130_yn) & is.na(AGQ140_yn) & is.na(AGQ180_yn) &
!is.na(AGD170) ~ 1L,
TRUE ~ NA_integer_)) %>%
mutate(
#primary analysis
ar_primary=case_when(
AGQ030_yn == 1L | AGQ100_yn == 1L ~ 1L,
AGQ100_yn == 0L & (is.na(AGQ030_yn) | AGQ030_yn == 0L) ~ 0L,
TRUE ~ NA_integer_),
#sensitivity definition if not AGQ030==1, then require all:
#AGQ100==1 AND sneeze_season >=1 AND allergy_any==1
ar_strict = case_when(
AGQ030_yn == 1L ~ 1L,
AGQ030_yn != 1L & AGQ100_yn == 1L &
!is.na(sneeze_season) & sneeze_season >= 1L &
allergy_any == 1L ~ 1L,
AGQ030_yn == 0L & AGQ100_yn == 0L ~ 0L,
TRUE ~ NA_integer_),
#Ever AR (for descriptive epi, not primary modeling)
ar_ever=case_when(
AGQ010_yn==1L | ar_primary==1L ~ 1L,
AGQ010_yn==0L & ar_primary==0L ~ 0L,
is.na(AGQ010) & !is.na(AGD020_yn) ~ 1L,
TRUE ~ NA_integer_)) %>%
select(SEQN, ar_primary, ar_strict, ar_ever, AGQ030_yn, AGQ100_yn,
allergy_any, animal_allergy, sneeze_any, sneeze_pattern,ar_related_sx)
dfs<-list(DEMO_D1,AGQ_D1, MCQ_D1,BMX_D2, AL_IGE_D1, HOQ_D1, HIQ_D1,
HUQ_D1, CBC_D1, COT_D1, CRP_D1, SMQ_D1)
raw<-reduce(dfs,~left_join(.x,.y,by="SEQN"))
write.csv(raw,file="/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/data/raw.csv",
row.names=TRUE)
save(raw,file='/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/data/raw.RData')
#Remember to do the calculations and make frequency tables based on the NHANES doc
# ====================================================
# 1) Build analysis dataset
# ====================================================
load("/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/data/raw.RData")
yes_no <- function(v) recode(v, `0`="No", `1`="Yes", .default=NA_character_)
library(caret)
library(tidyverse)
# automatically test high-correlated covariates and drop
remove_high_corr <- function(df, cutoff = 0.8) {
num_vars <- df %>% select(where(is.numeric)) %>% names()
num_data <- df %>% select(all_of(num_vars))
cor_mat <- cor(num_data, use="pairwise.complete.obs", method="spearman")
high_cor <- findCorrelation(cor_mat, cutoff = cutoff, names = TRUE)
message("Removing high-correlation variables: ", paste(high_cor, collapse=", "))
df %>% select(-all_of(high_cor))
}
data1 <- raw %>%
dplyr::filter(!is.na(ar_primary)) %>%
# only analysis on adults
filter(age_grp %in% c("20-39", "40-59", "60-84", "85+")) %>%
mutate(age_grp = factor(age_grp)) %>%
dplyr::select(
ar_primary, age_grp, sex, race, home_size, pir, edu_a, house_income, smq_status,
bmi_cat, fam_asthma_ever, asthma_ever, allergy_any, animal_allergy,
any_pet, mildew, home_type, home_year, num_rooms, any_ins,
health, time_visit, LBXEOPCT, nlr, elr, LBXIGE, crp_mg_l, cot_ng_ml
) %>%
dplyr::mutate(
ar_primary  = factor(ar_primary, levels = c(0, 1)), # positive = "1"
home_size   = as.character(home_size),
allergy_any = yes_no(allergy_any),
any_pet     = yes_no(any_pet),
animal_allergy=yes_no(animal_allergy),
mildew      = yes_no(mildew)
)
data2<-remove_high_corr(data1, cutoff = 0.8)
data_model<-data2
write.csv(data_model,file="/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/data/data.csv",
row.names=TRUE)
save(data_model,file='/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/data/data.RData')
str(data2)
