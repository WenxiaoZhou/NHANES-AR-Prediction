theme(
legend.position = "top",
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
plot.subtitle = element_text(size = 14),
axis.text = element_text(size = 13),
axis.title = element_text(size = 15)
)
ggplotly(p, tooltip = "text") %>%
layout(hoverlabel = list(bgcolor = "white", font = list(size = 13)))
})
# (2) ---- shapviz Waterfall Plot ----
output$waterfallPlot <- renderPlot({
i <- as.numeric(input$obs)
# Waterfall plot from shapviz object
p <- sv_waterfall(
sv,
row_id = i,
max_display = 15
) +
ggtitle(paste0("SHAP Waterfall Plot (Observation #", i, ")")) +
theme_minimal(base_size = 18) +
theme(
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
axis.text = element_text(size = 15),
axis.title = element_text(size = 18)
)
print(p)
})
}
# ---------------- Run ----------------
shinyApp(ui, server)
rsconnect::deployApp(
appDir = "/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/programs/support/force_dash1",
appPrimaryDoc = "SHAP_forceplot1.R",
appFiles = c(
"SHAP_forceplot1.R",
"rf_model_shap.rds",
"shap_values_mat.rds",
"shap_values_shap_avg.rds",
"shap_values_viz.rds",
"test_baked_viz.rds",
"test_data.rds",
"X_test_shap.rds"
),
appName = "ANLY699_AR_SHAP_Individual_Dashboard",
account = "wenxiaozh-datalearner"
)
############ Below Force plot execution need to base on Model1.R program #############
######################## Individual sample SHAP force plot ########################
library(ranger)
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(shapviz)
rf_model_shap        <- readRDS("rf_model_shap.rds")
shap_values_mat      <- readRDS("shap_values_mat.rds")
shap_values_viz      <- readRDS("shap_values_viz.rds")
shap_values_shap_avg <- readRDS("shap_values_shap_avg.rds")
test_baked_viz       <- readRDS("test_baked_viz.rds")
test                 <- readRDS("test_data.rds")
X_test_shap          <- readRDS("X_test_shap.rds")
# Compute base value as the mean predicted probability for class 1
# ---- Compute baseline (average predicted probability) ----
rf_pred <- ranger:::predict.ranger(rf_model_shap, data = X_test_shap)
base_value <- mean(rf_pred$predictions[, 2])
cat("âœ… Base value computed:", base_value, "\n")
sv <- shapviz(shap_values_mat, X = test_baked_viz, baseline = base_value)
combine_shap <- function(i, shap_values, X) {
tibble(
feature = names(X),
shap_value = as.numeric(shap_values[i, ]),
feature_value = as.character(as.vector(as.matrix(X[i, ])))
) %>%
mutate(
# Round numeric variables to 4 decimals (but not 0 or 1)
feature_value = ifelse(
suppressWarnings(!is.na(as.numeric(feature_value))),
ifelse(as.numeric(feature_value) %in% c(0, 1),
feature_value,
format(round(as.numeric(feature_value), 4), nsmall = 4)),
feature_value
),
feature_label = paste0(feature, " = ", feature_value),
direction = ifelse(shap_value >= 0, "increase", "decrease")
) %>%
arrange(desc(abs(shap_value)))
}
# ---------------- UI ----------------
ui <- fluidPage(
titlePanel("SHAP Force-like and Waterfall Visualizer"),
sidebarLayout(
sidebarPanel(
selectInput(
"obs",
"Select Observation:",
choices = 1:nrow(test_baked_viz),
selected = 1
),
helpText("Red bars â†’ Increase AR probability | Blue bars â†’ Decrease")
),
mainPanel(
tabsetPanel(
tabPanel("ðŸ”¹ Force-like Bar Plot (Top Features)",
plotlyOutput("shapPlot", height = "750px")),
tabPanel("ðŸ”¸ Waterfall Plot (shapviz)",
plotOutput("waterfallPlot", height = "750px"))
)
)
)
)
# ---------------- SERVER ----------------
server <- function(input, output, session) {
# (1) ---- Force-like Interactive Plot ----
output$shapPlot <- renderPlotly({
i <- as.numeric(input$obs)
df <- combine_shap(i, shap_values_viz, test_baked_viz)
p <- ggplot(df %>% slice_max(order_by = abs(shap_value), n = 15),
aes(
x = reorder(feature_label, shap_value),
y = shap_value,
fill = direction,
text = paste0(
"<b>Feature:</b> ", feature, "<br>",
"<b>Value:</b> ", feature_value, "<br>",
"<b>SHAP:</b> ", round(shap_value, 4)
)
)) +
geom_col() +
coord_flip() +
scale_fill_manual(values = c("increase" = "#E64B35", "decrease" = "#4DBBD5")) +
labs(
title = paste0("Top SHAP Contributions (Observation #", i, ")"),
x = "Feature (with value)", y = "SHAP value",
subtitle = "Hover to view details"
) +
theme_minimal(base_size = 16) +
theme(
legend.position = "top",
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
plot.subtitle = element_text(size = 14),
axis.text = element_text(size = 13),
axis.title = element_text(size = 15)
)
ggplotly(p, tooltip = "text") %>%
layout(hoverlabel = list(bgcolor = "white", font = list(size = 13)))
})
# (2) ---- shapviz Waterfall Plot ----
output$waterfallPlot <- renderPlot({
i <- as.numeric(input$obs)
# Waterfall plot from shapviz object
p <- sv_waterfall(
sv,
row_id = i,
max_display = 15
) +
ggtitle(paste0("SHAP Waterfall Plot (Observation #", i, ")")) +
theme_minimal(base_size = 18) +
theme(
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
axis.text = element_text(size = 15),
axis.title = element_text(size = 18)
)
print(p)
})
}
# ---------------- Run ----------------
shinyApp(ui, server)
library(rsconnect)
# Optional: verify rsconnect setup
rsconnect::setAccountInfo(
name    = "wenxiaozh-datalearner",
token   = "<your_token>",     # only needed if not already configured
secret  = "<your_secret>"
)
library(rsconnect)
rsconnect::deployApp(
appDir        = "/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/programs/support/force_dash1",
appPrimaryDoc = "SHAP_forceplot1.R",
appName       = "ANLY699_AR_SHAP_Individual_Dashboard",
account       = "wenxiaozh-datalearner",
launch.browser = TRUE
)
############ Below Force plot execution need to base on Model1.R program #############
######################## Individual sample SHAP force plot ########################
library(ranger)
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(shapviz)
rf_model_shap        <- readRDS("rf_model_shap.rds")
shap_values_mat      <- readRDS("shap_values_mat.rds")
shap_values_viz      <- readRDS("shap_values_viz.rds")
shap_values_shap_avg <- readRDS("shap_values_shap_avg.rds")
test_baked_viz       <- readRDS("test_baked_viz.rds")
test                 <- readRDS("test_data.rds")
X_test_shap          <- readRDS("X_test_shap.rds")
# Compute base value as the mean predicted probability for class 1
# ---- Compute baseline (average predicted probability) ----
rf_pred <- ranger:::predict.ranger(rf_model_shap, data = X_test_shap)
base_value <- mean(rf_pred$predictions[, 2])
cat("âœ… Base value computed:", base_value, "\n")
sv <- shapviz(shap_values_mat, X = test_baked_viz, baseline = base_value)
combine_shap <- function(i, shap_values, X) {
tibble(
feature = names(X),
shap_value = as.numeric(shap_values[i, ]),
feature_value = as.character(as.vector(as.matrix(X[i, ])))
) %>%
mutate(
# Round numeric variables to 4 decimals (but not 0 or 1)
feature_value = ifelse(
suppressWarnings(!is.na(as.numeric(feature_value))),
ifelse(as.numeric(feature_value) %in% c(0, 1),
feature_value,
format(round(as.numeric(feature_value), 4), nsmall = 4)),
feature_value
),
feature_label = paste0(feature, " = ", feature_value),
direction = ifelse(shap_value >= 0, "increase", "decrease")
) %>%
arrange(desc(abs(shap_value)))
}
# ---------------- UI ----------------
ui <- fluidPage(
sidebarLayout(
sidebarPanel(
selectInput(
"obs",
"Select Observation:",
choices = 1:nrow(test_baked_viz),
selected = 1
),
helpText("Red bars â†’ Increase AR probability | Blue bars â†’ Decrease")
),
mainPanel(
tabsetPanel(
tabPanel("ðŸ”¹ Forced Bar Plot (Top Features)",
plotlyOutput("shapPlot", height = "750px")),
tabPanel("ðŸ”¸ Version 2",
plotOutput("waterfallPlot", height = "750px"))
)
)
)
)
# ---------------- SERVER ----------------
server <- function(input, output, session) {
# (1) ---- Force-like Interactive Plot ----
output$shapPlot <- renderPlotly({
i <- as.numeric(input$obs)
df <- combine_shap(i, shap_values_viz, test_baked_viz)
p <- ggplot(df %>% slice_max(order_by = abs(shap_value), n = 15),
aes(
x = reorder(feature_label, shap_value),
y = shap_value,
fill = direction,
text = paste0(
"<b>Feature:</b> ", feature, "<br>",
"<b>Value:</b> ", feature_value, "<br>",
"<b>SHAP:</b> ", round(shap_value, 4)
)
)) +
geom_col() +
coord_flip() +
scale_fill_manual(values = c("increase" = "#E64B35", "decrease" = "#4DBBD5")) +
labs(
title = paste0("Top SHAP Contributions (Observation #", i, ")"),
x = "Feature (with value)", y = "SHAP value",
subtitle = "Hover to view details"
) +
theme_minimal(base_size = 16) +
theme(
legend.position = "top",
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
plot.subtitle = element_text(size = 14),
axis.text = element_text(size = 13),
axis.title = element_text(size = 15)
)
ggplotly(p, tooltip = "text") %>%
layout(hoverlabel = list(bgcolor = "white", font = list(size = 13)))
})
# (2) ---- shapviz Waterfall Plot ----
output$waterfallPlot <- renderPlot({
i <- as.numeric(input$obs)
# Waterfall plot from shapviz object
p <- sv_waterfall(
sv,
row_id = i,
max_display = 15
) +
ggtitle(paste0("SHAP Waterfall Plot (Observation #", i, ")")) +
theme_minimal(base_size = 18) +
theme(
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
axis.text = element_text(size = 15),
axis.title = element_text(size = 18)
)
print(p)
})
}
# ---------------- Run ----------------
shinyApp(ui, server)
############ Below Force plot execution need to base on Model1.R program #############
######################## Individual sample SHAP force plot ########################
library(ranger)
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(shapviz)
rf_model_shap        <- readRDS("rf_model_shap.rds")
shap_values_mat      <- readRDS("shap_values_mat.rds")
shap_values_viz      <- readRDS("shap_values_viz.rds")
shap_values_shap_avg <- readRDS("shap_values_shap_avg.rds")
test_baked_viz       <- readRDS("test_baked_viz.rds")
test                 <- readRDS("test_data.rds")
X_test_shap          <- readRDS("X_test_shap.rds")
# Compute base value as the mean predicted probability for class 1
# ---- Compute baseline (average predicted probability) ----
rf_pred <- ranger:::predict.ranger(rf_model_shap, data = X_test_shap)
base_value <- mean(rf_pred$predictions[, 2])
cat("âœ… Base value computed:", base_value, "\n")
sv <- shapviz(shap_values_mat, X = test_baked_viz, baseline = base_value)
combine_shap <- function(i, shap_values, X) {
tibble(
feature = names(X),
shap_value = as.numeric(shap_values[i, ]),
feature_value = as.character(as.vector(as.matrix(X[i, ])))
) %>%
mutate(
# Round numeric variables to 4 decimals (but not 0 or 1)
feature_value = ifelse(
suppressWarnings(!is.na(as.numeric(feature_value))),
ifelse(as.numeric(feature_value) %in% c(0, 1),
feature_value,
format(round(as.numeric(feature_value), 4), nsmall = 4)),
feature_value
),
feature_label = paste0(feature, " = ", feature_value),
direction = ifelse(shap_value >= 0, "increase", "decrease")
) %>%
arrange(desc(abs(shap_value)))
}
# ---------------- UI ----------------
ui <- fluidPage(
sidebarLayout(
sidebarPanel(
selectInput(
"obs",
"Select Observation:",
choices = 1:nrow(test_baked_viz),
selected = 1
),
helpText("Red bars â†’ Increase AR probability | Blue bars â†’ Decrease")
),
mainPanel(
plotlyOutput("shapPlot", height = "750px")
)
)
)
# ---------------- SERVER ----------------
server <- function(input, output, session) {
# ---- Force-like Interactive Plot ----
output$shapPlot <- renderPlotly({
i <- as.numeric(input$obs)
df <- combine_shap(i, shap_values_viz, test_baked_viz)
p <- ggplot(df %>% slice_max(order_by = abs(shap_value), n = 15),
aes(
x = reorder(feature_label, shap_value),
y = shap_value,
fill = direction,
text = paste0(
"<b>Feature:</b> ", feature, "<br>",
"<b>Value:</b> ", feature_value, "<br>",
"<b>SHAP:</b> ", round(shap_value, 4)
)
)) +
geom_col() +
coord_flip() +
scale_fill_manual(values = c("increase" = "#E64B35", "decrease" = "#4DBBD5")) +
labs(
title = paste0("Top SHAP Contributions (Observation #", i, ")"),
x = "Feature (with value)", y = "SHAP value",
subtitle = "Hover to view details"
) +
theme_minimal(base_size = 16) +
theme(
legend.position = "top",
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
plot.subtitle = element_text(size = 14),
axis.text = element_text(size = 13),
axis.title = element_text(size = 15)
)
ggplotly(p, tooltip = "text") %>%
layout(hoverlabel = list(bgcolor = "white", font = list(size = 13)))
})
}
# ---------------- Run ----------------
shinyApp(ui, server)
library(rsconnect)
rsconnect::deployApp(
appDir        = "/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/programs/support/force_dash1",
appPrimaryDoc = "SHAP_forceplot1.R",
appName       = "ANLY699_AR_SHAP_Individual_Dashboard",
account       = "wenxiaozh-datalearner",
launch.browser = TRUE
)
############ Below Force plot execution need to base on Model1.R program #############
######################## Individual sample SHAP force plot ########################
library(ranger)
library(shiny)
library(ggplot2)
library(dplyr)
library(plotly)
library(shapviz)
rf_model_shap        <- readRDS("rf_model_shap.rds")
shap_values_mat      <- readRDS("shap_values_mat.rds")
shap_values_viz      <- readRDS("shap_values_viz.rds")
shap_values_shap_avg <- readRDS("shap_values_shap_avg.rds")
test_baked_viz       <- readRDS("test_baked_viz.rds")
test                 <- readRDS("test_data.rds")
X_test_shap          <- readRDS("X_test_shap.rds")
# Compute base value as the mean predicted probability for class 1
# ---- Compute baseline (average predicted probability) ----
rf_pred <- ranger:::predict.ranger(rf_model_shap, data = X_test_shap)
base_value <- mean(rf_pred$predictions[, 2])
cat("âœ… Base value computed:", base_value, "\n")
sv <- shapviz(shap_values_mat, X = test_baked_viz, baseline = base_value)
combine_shap <- function(i, shap_values, X) {
tibble(
feature = names(X),
shap_value = as.numeric(shap_values[i, ]),
feature_value = as.character(as.vector(as.matrix(X[i, ])))
) %>%
mutate(
# Round numeric variables to 4 decimals (but not 0 or 1)
feature_value = ifelse(
suppressWarnings(!is.na(as.numeric(feature_value))),
ifelse(as.numeric(feature_value) %in% c(0, 1),
feature_value,
format(round(as.numeric(feature_value), 4), nsmall = 4)),
feature_value
),
feature_label = paste0(feature, " = ", feature_value),
direction = ifelse(shap_value >= 0, "increase", "decrease")
) %>%
arrange(desc(abs(shap_value)))
}
# ---------------- UI ----------------
ui <- fluidPage(
titlePanel("Interactive SHAP Force Plot for Allergic Rhinitis Prediction"),
sidebarLayout(
sidebarPanel(
selectInput(
"obs",
"Select Observation:",
choices = 1:nrow(test_baked_viz),
selected = 1
),
helpText("ðŸ”´ Red bars indicate features that increase AR probability; ðŸ”µ Blue bars indicate features that decrease it.")
),
mainPanel(
plotlyOutput("shapPlot", height = "750px")
)
)
)
# ---------------- SERVER ----------------
server <- function(input, output, session) {
# ---- Force-like Interactive Plot ----
output$shapPlot <- renderPlotly({
i <- as.numeric(input$obs)
df <- combine_shap(i, shap_values_viz, test_baked_viz)
p <- ggplot(df %>% slice_max(order_by = abs(shap_value), n = 15),
aes(
x = reorder(feature_label, shap_value),
y = shap_value,
fill = direction,
text = paste0(
"<b>Feature:</b> ", feature, "<br>",
"<b>Value:</b> ", feature_value, "<br>",
"<b>SHAP:</b> ", round(shap_value, 4)
)
)) +
geom_col() +
coord_flip() +
scale_fill_manual(values = c("increase" = "#E64B35", "decrease" = "#4DBBD5")) +
labs(
title = paste0("Top SHAP Feature Contributions (Observation #", i, ")"),
x = "Feature (with value)", y = "SHAP value"
) +
theme_minimal(base_size = 16) +
theme(
legend.position = "top",
plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
axis.text = element_text(size = 13),
axis.title = element_text(size = 15)
)
ggplotly(p, tooltip = "text") %>%
layout(hoverlabel = list(bgcolor = "white", font = list(size = 13)))
})
}
# ---------------- Run ----------------
shinyApp(ui, server)
library(rsconnect)
rsconnect::deployApp(
appDir        = "/Users/zhouwenxiao/Desktop/ANLY699/Final Project Related/programs/support/force_dash1",
appPrimaryDoc = "SHAP_forceplot1.R",
appName       = "ANLY699_AR_SHAP_Individual_Dashboard",
account       = "wenxiaozh-datalearner",
launch.browser = TRUE
)
